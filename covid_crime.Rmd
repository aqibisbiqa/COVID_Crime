---
title: "Visualizing U.S. Crime and Law Enforcement in the 2010s"
author: "Aqib Mahfuz"
date: "5/1/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

```{r loading-libraries, echo=F, warning=F, message=F}
# Loading libraries for project

library(tidyverse)
library(ggplot2)

library(rjson)  # for reading JSON files from API and more
library(jsonlite)
library(RJSONIO)

library(usmap)  # for easily plotting map of United States
library(ggpubr) # for putting multiple plots into one figure
```

## Background
Among the several divisive issues facing the United States in the early 2020s, the topics of policing and criminal activity have stood out in terms of the tension they've created within the American people. On one hand (Defund the police), and on the other (double down on law and order). To clarify, this experiment will not explicitly revolve around the issue of police brutality (statistics which are, regrettably, underreported). Rather, the goal is to analyze trends in crime and law enforcement between 2010 and 2019. Which types of crimes are the most prevalent and on the rise this past decade? 
We aim to tackle three central questions:
1. What effect does 



## Hypotheses



## Procedure

```{r setting-up-api, echo=F, warning=F, message=F}
# Setting up API calls
creds <- rjson::fromJSON(file = '../crime_data_api_credentials.json')
API_KEY <- creds$api_key
CDE_URL <- "https://api.usa.gov/crime/fbi/sapi"
```

## 1. Visualizing Police Employment

```{r national-police-employment-data, echo=F, warning=F, message=F}
# Getting API level police employment data (get male and female officer data)
pe_url <- paste("https://api.usa.gov/crime/fbi/sapi/api/police-employment/national/2010/2019?API_KEY=", API_KEY, sep="")

pe <- jsonlite::fromJSON(pe_url)$results %>% 
  subset(select=-c(agency_count_pe_submitting, csv_header)) %>% 
  mutate(officer_ct = total_pe_ct-civilian_ct) %>% 
  mutate(officer_ct_per_1000 = round(officer_ct*1000/population, digits=2)) %>% 
  mutate(civilian_ct_per_1000 = round(civilian_ct*1000/population, digits=2)) %>% 
  mutate(female_officer_prop = female_officer_ct/officer_ct) %>% 
  mutate(female_civilian_prop = female_civilian_ct/civilian_ct) %>% 
  mutate(female_total_prop = female_total_ct/total_pe_ct)

rm(pe_url)
```

```{r state-police-employment-data, echo=F, warning=F, message=F}
# Police Employment

#The Police Employee dataset is made up of data collected annually about law enforcement officers and civilians employed by law enforcement agencies. The dataset contains information about the number of officers and civilians employed and the rate of police employees per a locationâ€™s population.

#The Uniform Crime Reporting (UCR) Program defines law enforcement officers as individuals who ordinarily carry a firearm and a badge, have full arrest powers, and are paid from governmental funds set aside specifically for sworn law enforcement representatives.

pe_states <- read.csv("pe_1960_2019.csv") %>% 
  rename(state=state_postal_abbr)

pe_recent <- pe_states %>%
  drop_na(officer_rate_per_1000) %>% 
  filter(data_year >= 2010 & data_year <= 2019) %>% 
  filter(state != "PR") %>% 
  mutate(total_rate_per_1000 = officer_rate_per_1000 + civilian_rate_per_1000)

pe_states_min <- pe_recent %>% 
  group_by(data_year) %>% 
  slice_min(order_by=officer_rate_per_1000, n=5)

pe_states_max <- pe_recent %>% 
  group_by(data_year) %>% 
  slice_max(order_by=officer_rate_per_1000, n=5)

pe_states_spread <- pe_recent %>% 
  mutate(total_rate_per_1000 = officer_rate_per_1000 + civilian_rate_per_1000) %>% 
  group_by(state) %>% 
  summarise(officer_to = sd(officer_rate_per_1000), 
            civilian_to = sd(civilian_rate_per_1000), 
            total_to = sd(total_rate_per_1000))

rm(pe_states)
```

```{r state-population-data, echo=F, warning=F, message=F}
full_pop <- read_csv("pop_estimates_2010_2019.csv") %>% 
  select(`NAME`:`POPESTIMATE2019`) %>% 
  filter(!(NAME %in% c("Northeast Region", "Midwest Region", "South Region", "West Region"))) %>% 
  subset(select=-c(CENSUS2010POP,ESTIMATESBASE2010))
colnames(full_pop) <- c("state", 2010:2019)

abbrevs <- read_csv("state_abbreviations.csv") %>% 
  rbind(data.frame(State="United States", Abbrev="USA", Code="USA")) %>% 
  rename_with(tolower)

pop <- merge(full_pop, abbrevs, by="state") %>% 
  select(code, `2010`:`2019`) %>% 
  rename(state = code) %>% 
  gather(key="data_year", value="pop", `2010`:`2019`)

rm(full_pop, abbrevs)
```

```{r echo=F, warning=F, message=F}

# for officers
state_summary <- pe_recent %>% 
  group_by(state) %>% 
  summarise(rate=mean(officer_rate_per_1000))

plot_usmap(data=state_summary,
           values="rate",
           color="black")+
  scale_fill_continuous(low="white", high="steelblue4",
                        name="Officers per 1000")+
  theme(legend.position="right")


plot_usmap(data=pe_recent,
           values="officer_rate_per_1000",
           color="black")+
  scale_fill_continuous(low="white", high="steelblue4",
                        name="Officers per 1000")+
  theme(legend.position="right")+
  facet_wrap(vars(data_year), ncol=5)

rm(state_summary)


# for civilians
state_summary <- pe_recent %>% 
  group_by(state) %>% 
  summarise(rate=mean(civilian_rate_per_1000))

plot_usmap(data=state_summary,
           values="rate",
           color="black")+
  scale_fill_continuous(low="white", high="steelblue4",
                        name="Civilians per 1000")+
  theme(legend.position="right")

plot_usmap(data=pe_recent,
           values="civilian_rate_per_1000",
           color="black")+
  scale_fill_continuous(low="white", high="steelblue4",
                        name="Civilians per 1000")+
  theme(legend.position="right")+
  facet_wrap(vars(data_year), ncol=5)


rm(state_summary)
```

```{r echo=F, warning=F, message=F}
# Maps of Police Employment for each year
pe10 <- plot_usmap(data=filter(pe_recent, data_year==2010),
                   values="officer_rate_per_1000",
                   color="black")+
  scale_fill_continuous(low="white", high="steelblue4",
                        name="Officers per 1000")+
  theme(legend.position="none")

pe11 <- plot_usmap(data=filter(pe_recent, data_year==2011),
                   values="officer_rate_per_1000",
                   color="black")+
  scale_fill_continuous(low="white", high="steelblue4",
                        name="Officers per 1000")+
  theme(legend.position="none")

pe12 <- plot_usmap(data=filter(pe_recent, data_year==2012),
                   values="officer_rate_per_1000",
                   color="black")+
  scale_fill_continuous(low="white", high="steelblue4",
                        name="Officers per 1000")+
  theme(legend.position="none")

pe13 <- plot_usmap(data=filter(pe_recent, data_year==2013),
                   values="officer_rate_per_1000",
                   color="black")+
  scale_fill_continuous(low="white", high="steelblue4",
                        name="Officers per 1000")+
  theme(legend.position="none")

pe14 <- plot_usmap(data=filter(pe_recent, data_year==2014),
                   values="officer_rate_per_1000",
                   color="black")+
  scale_fill_continuous(low="white", high="steelblue4",
                        name="Officers per 1000")+
  theme(legend.position="none")

pe15 <- plot_usmap(data=filter(pe_recent, data_year==2015),
                   values="officer_rate_per_1000",
                   color="black")+
  scale_fill_continuous(low="white", high="steelblue4",
                        name="Officers per 1000")+
  theme(legend.position="none")

pe16 <- plot_usmap(data=filter(pe_recent, data_year==2016),
                   values="officer_rate_per_1000",
                   color="black")+
  scale_fill_continuous(low="white", high="steelblue4",
                        name="Officers per 1000")+
  theme(legend.position="none")

pe17 <- plot_usmap(data=filter(pe_recent, data_year==2017),
                   values="officer_rate_per_1000",
                   color="black")+
  scale_fill_continuous(low="white", high="steelblue4",
                        name="Officers per 1000")+
  theme(legend.position="none")

pe18 <- plot_usmap(data=filter(pe_recent, data_year==2018),
                   values="officer_rate_per_1000",
                   color="black")+
  scale_fill_continuous(low="white", high="steelblue4",
                        name="Officers per 1000")+
  theme(legend.position="none")

pe19 <- plot_usmap(data=filter(pe_recent, data_year==2019),
                   values="officer_rate_per_1000",
                   color="black")+
  scale_fill_continuous(low="white", high="steelblue4",
                        name="Officers per 1000")+
  theme(legend.position="none")

ggarrange(pe10, pe11, pe12, pe13, pe14, pe15, pe16, pe17, pe18, pe19,
          labels=c(2010:2019),
          ncol=5, nrow=2,
          common.legend=T)

rm(pe10)
rm(pe11)
rm(pe12)
rm(pe13)
rm(pe14)
rm(pe15)
rm(pe16)
rm(pe17)
rm(pe18)
rm(pe19)
```

**Fig. 1:** Police employment per 1000 citizens across US from 2010 to 2019. Darker tones indicate higher rates of employment.

```{r echo=F, warning=F, message=F}
#make lines thicker

pe_cats <- pe %>% select(data_year, officer_ct_per_1000, civilian_ct_per_1000, pe_ct_per_1000) %>% 
  gather(cat, prop, -data_year)

ggplot(data=pe_cats, aes(x=data_year, y=prop, group=cat))+
  geom_line(aes(color=cat))+
  geom_point()+
  scale_x_continuous(name="Year", breaks=c(2010:2019), labels=c(2010:2019))+
  scale_y_continuous(name="Count per 1000")+
  scale_color_manual(name="Type", labels=c("Civilian", "Officer", "Total"), values=c("green", "blue", "red"))

rm(pe_cats)
```

**Fig 2:** Police employment per 1000 citizens on national scale.

```{r echo=F, warning=F, message=F}
civ_props <- pe %>% select(data_year, civilian_ct, total_pe_ct) %>% 
  mutate(civ_prop = civilian_ct/total_pe_ct)

ggplot(data=civ_props, aes(x=data_year, y=civ_prop, fill=data_year))+
  geom_bar(stat="identity")+
  scale_x_continuous(name="Year", breaks=c(2010:2019), labels=c(2010:2019))+
  scale_y_continuous(name="Proportion")+
  theme(legend.position="none")

rm(civ_props)
```

**Fig 3:** National proportion of civilians in law enforcement

```{r echo=F, warning=F, message=F}
female_props <- pe %>% select(data_year, female_officer_prop:female_total_prop) %>% 
  gather(cat, prop, -data_year)

ggplot(data=female_props, aes(x=data_year, y=prop, group=cat))+
  geom_line(aes(color=cat))+
  geom_point()+
  scale_x_continuous(name="Year", breaks=c(2010:2019), labels=c(2010:2019))+
  scale_y_continuous(name="Proportion of Females")+
  scale_color_manual(name="Type", labels=c("Civilian", "Officer", "Total"), values=c("green", "blue", "red"))


rm(female_props)
```

**Fig 4:** National proportion of females in law enforcement

```{r echo=F, warning=F, message=F}
ggplot(data=pe_states_spread, aes(y=reorder(state, total_to), x=total_to, fill=reorder(state, total_to)))+
  geom_bar(stat="identity")+
  xlab("Rate of Turnover")+
  ylab("State")+
  theme(legend.position="none")
```

**Fig 5:** Normalized average turnover in police employment across US from 2010 to 2019. Darker tones indicate higher rates of turnover.


## 2. Visualizing Crime Rates

```{r national-crime-data, echo=F, warning=F, message=F}
# Import national level offense data (arson, rape, etc.)

# Unfortunately, state and agency level offense data is troublesome to obtain. Moreover, the FBI discourages using lower level data to make comparisons between states/agencies. As such, we will only look at national level data.

offense_url_1 <- "https://api.usa.gov/crime/fbi/sapi/api/nibrs"
offense_url_2 <- "offender/national"

offenses <- c("aggravated-assault", "burglary", "larceny", "motor-vehicle-theft", 
              "homicide", "rape", "robbery", "arson", "violent-crime", "property-crime")
cats <- c("count", "age", "race", "sex")

offenses_df <- data.frame(offense = c(),
                          stringsAsFactors=F)

for (off in offenses){
  temp <- data.frame(data_year = integer(),
                     stringsAsFactors=F)
  for (cat in cats){
    offense_url <- paste(paste(offense_url_1, off, offense_url_2, cat, sep="/"), "?", "API_KEY=", API_KEY, sep="")
    query_data <- jsonlite::fromJSON(offense_url)
    
    df <- query_data$data %>% 
      subset(select=-c(month_num)) %>% 
      group_by(data_year) %>%
      mutate(k = key) %>%
      spread(k, value) %>% 
      mutate_if(is.numeric, funs(ifelse(is.na(.), 0, .))) %>% 
      summarise_if(is.numeric, funs(sum))
    
    colnames(df) <- colnames(df) %>% 
      lapply(tolower) %>% 
      unlist()
    if ("unknown" %in% colnames(df)){
      colnames(df)[which(colnames(df) %in% "unknown")] <- paste("unknown_", cat, sep="")
    }
    
    temp <- merge(temp, df, 
                  by="data_year",
                  all=T)
  }
  temp <- temp %>% 
    mutate(offense = off)
  offenses_df <- rbind(offenses_df, temp)
}

new_col_order <- colnames(offenses_df) %>% 
  append("offense", after=1)
new_col_order <- new_col_order[-length(new_col_order)]

offenses_df <- offenses_df[,new_col_order] %>% 
  filter(data_year >= 2010 & data_year <= 2019) %>% 
  merge(pop, by="data_year")

rm(offense_url_1)
rm(offense_url_2)
rm(offense_url)
rm(off)
rm(cat)
rm(query_data)
rm(df)
rm(new_col_order)
```

```{r state-crime-data-1, echo=F, warning=F, message=F}
# Importing state level crime data

states <- c("AL", "AZ", "AR", "CO", "CT", "DE",
            "DC", "ID", "IL", "IA", "KS",
            "KY", "LA", "ME", "MA", "MI", "MO",
            "MT", "NE", "NH", "ND", "OH", "OK",
            "OR", "RI", "SC", "SD", "TN",
            "TX", "UT", "VT", "VA", "WA", "WV",
            "WI")

ref_race <- read.csv("state_crime_data/AL/AL-2010/ref_race.csv") %>% 
  select(race_id, race_desc)

# offense type lookups
nibrs_offense_type <- read.csv("state_crime_data/AL/AL-2010/nibrs_offense_type.csv")
names(nibrs_offense_type) <- tolower(names(nibrs_offense_type))
nibrs_offense_type <- nibrs_offense_type %>% 
  select(offense_type_id, offense_name, offense_category_name)

state_crime = data.frame()

for (state in states){
  state_data = data.frame()

  for (year in c(2010:2019)){
    # getting file location
    loc <- paste("state_crime_data/", state, "/", state, "-", year, sep="")
    if (year %in% 2016:2019){
      loc <- paste(loc, "/", state, sep="")
    }
    
    loc
    
    # offender data
    nibrs_offender <- read.csv(paste(loc, "/", 
                                     "nibrs_offender", ".csv", sep="")) 
    names(nibrs_offender) <- tolower(names(nibrs_offender))
    nibrs_offender <- nibrs_offender %>% 
      select(incident_id, age_num, sex_code, race_id)
    
    # offense data
    nibrs_offense <- read.csv(paste(loc, "/", 
                                     "nibrs_offense", ".csv", sep=""))
    names(nibrs_offense) <- tolower(names(nibrs_offense))
    nibrs_offense <- nibrs_offense %>% 
      select(incident_id, offense_type_id)
    
    # merging stuff
    temp <- merge(nibrs_offender, nibrs_offense, by="incident_id")
      # ages
    ages <- temp %>% group_by(age_num, offense_type_id) %>% 
      summarise(ct = n()) %>% 
      drop_na() %>% 
      mutate(age_group = 
               case_when(age_num >= 0 & age_num <= 9 ~ "0_9",
                         age_num >= 10 & age_num <= 19 ~ "10_19",
                         age_num >= 20 & age_num <= 29 ~ "20_29",
                         age_num >= 30 & age_num <= 39 ~ "30_39",
                         age_num >= 40 & age_num <= 49 ~ "40_49",
                         age_num >= 50 & age_num <= 59 ~ "50_59",
                         age_num >= 60 & age_num <= 69 ~ "60_69",
                         age_num >= 70 & age_num <= 79 ~ "70_79",
                         age_num >= 80 & age_num <= 89 ~ "80_89",
                         TRUE ~ "90_older")
             ) %>% 
      subset(select=-c(age_num)) %>% 
      group_by(age_group, offense_type_id) %>% 
      summarise(age_ct = sum(ct))
      # sexes
    sexes <- temp %>% group_by(sex_code, offense_type_id) %>% 
      summarise(sex_ct = n()) %>% 
      drop_na() %>% 
      filter(sex_code == "M" | sex_code == "F")
      # races
    races <- temp %>% group_by(race_id, offense_type_id) %>% 
      summarise(race_ct = n()) %>% 
      drop_na() %>% 
      filter(race_id != 0)

    df <- merge(ages, 
                merge(sexes, races, by="offense_type_id", all=T),
                by="offense_type_id",
                all=T) %>% 
      mutate_if(is.numeric, funs(ifelse(is.na(.), 0, .)))

    yearly_data <- cbind(data.frame(data_year = year,
                                    state = state,
                                    stringsAsFactors = F),
                         df)
    state_data <- rbind(yearly_data, state_data)
  }
  
  state_crime <- rbind(state_crime, state_data)
}

sc <- state_crime %>% 
  spread(age_group, age_ct) %>% 
  subset(select=-c(18)) %>% 
  spread(sex_code, sex_ct) %>% 
  subset(select=-c(18)) %>% 
  filter(race_id != 0) %>% 
  merge(ref_race, by="race_id") %>% 
  spread(race_desc, race_ct) %>% 
  subset(select=-c(1, 21)) %>% 
  merge(nibrs_offense_type, by="offense_type_id") %>% 
  subset(select=-c(1, 22)) %>% 
  mutate_if(is.numeric, funs(ifelse(is.na(.), 0, .)))

if (T){
  sc <- sc %>% 
    mutate(cat=
             case_when(offense_category_name %in% c("All Other Offenses",
                                                    "Other Offenses",
                                                    "Peeping Tom",
                                                    "Animal Cruelty",
                                                    "Curfew/Loitering/Vagrancy Violations",
                                                    "Disorderly Conduct",
                                                    "Weapon Law Violations"
                                                    ) ~ "Other",
                       offense_category_name %in% c("Arson"
                                                    ) ~ "Arson",
                       offense_category_name %in% c("Assault Offenses"
                                                    ) ~ "Aggravated_Assault",
                       offense_category_name %in% c("Bad Checks",
                                                    "Bribery",
                                                    "Counterfeiting/Forgery",
                                                    "Embezzlement",
                                                    "Extortion/Blackmail",
                                                    "Fraud Offenses",
                                                    "Gambling Offenses"
                                                    ) ~ "Financial_Crime",
                       offense_category_name %in% c("Burglary/Breaking & Entering"
                                                    ) ~ "Burglary",
                       offense_category_name %in% c("Destruction/Damage/Vandalism of Property",
                                                    "Stolen Property Offenses",
                                                    "Tresspass of Real Property"
                                                    ) ~ "Property_Crime",
                       offense_category_name %in% c("Drug/Narcotic Offenses",
                                                    "Driving Under the Influence",
                                                    "Drunkenness",
                                                    "Liquor Law Violations"
                                                    ) ~ "Narcotics/Alcohol",
                       offense_category_name %in% c("Homicide Offenses"
                                                    ) ~ "Homicide",
                       offense_category_name %in% c("Human Trafficking",
                                                    "Kidnapping/Abduction"
                                                    ) ~ "Trafficking",
                       offense_category_name %in% c("Larceny/Theft Offenses"
                                                    ) ~ "Larceny",
                       offense_category_name %in% c("Motor Vehicle Theft"
                                                    ) ~ "Motor_Vehicle_Theft",
                       offense_category_name %in% c("Prostitution Offenses",
                                                    "Sex Offenses",
                                                    "Sex Offenses, Non-forcible",
                                                    "Pornography/Obscene Material"
                                                    ) ~ "Sex_Crime",
                       offense_category_name %in% c("Robbery"
                                                    ) ~ "Robbery",
                       TRUE ~ "umm what"))
}

rm(ref_race)
rm(ages, races, sexes)
rm(df, state_data, yearly_data, temp)
rm(year, state)
rm(nibrs_offender, nibrs_offense, nibrs_offense_type)
rm(f, file, files, floc, loc)
```

```{r state-crime-data-2, echo=F, warning=F, message=F}
# recategorize offenses
sc_long <- sc %>% 
  group_by(data_year, state, cat) %>% 
  summarise("male" = sum(`M`),
            "female" = sum(`F`),
            "native_american" = sum(`American Indian or Alaska Native`),
            "asian" = sum(Asian, `Asian, Native Hawaiian, or Other Pacific Islander`),
            "black" = sum(`Black or African American`),
            "white" = sum(White),
            "0_9" = sum(`0_9`),
            "10_19" = sum(`10_19`),
            "20_29" = sum(`20_29`),
            "30_39" = sum(`30_39`),
            "40_49" = sum(`40_49`),
            "50_59" = sum(`50_59`),
            "60_69" = sum(`60_69`),
            "70_79" = sum(`70_79`),
            "80_89" = sum(`80_89`),
            "90_older" = sum(`90_older`)
            ) %>% 
  ungroup() %>% 
  mutate(total_offenses = select(., `male`:`90_older`) %>% rowSums(na.rm=T)) %>% 
  merge(pop, by=c("data_year", "state"))

sc_long[,4:20] <- sc_long[,4:20] / sc_long[,21] * 1000
sc_long <- mutate(sc_long, total_offenses = total_offenses/3)

sc_wide <- sc_long %>%
  spread(cat, total_offenses) %>% 
  mutate_if(is.numeric, funs(ifelse(is.na(.), 0, .))) %>% 
  #select(data_year, state, Aggravated_Assault:Trafficking) %>% 
  group_by(data_year, state) %>% 
  summarise_all(list(sum))
    
```

```{r echo=F, warning=F, message=F}

```



```{r echo=F, warning=F, message=F}
off_summary <- offenses_df %>% 
  group_by(offense) %>% 
  summarise(tot = sum(count))

ggplot(data=off_summary,
       aes(y=reorder(offense, tot), x=tot))+
  geom_bar(stat="identity")+
  geom_text(aes(label=tot), position=position_dodge(width=0.9), hjust=-0.05)+
  xlab("Total Incidents")+
  ylab("Offense")


#temp <- reorder(off_summary$offense, off_summary$avg, order=T)
#levels(fct_rev(temp))

rm(off_summary)
```

**Fig 6:** Most common crimes committed from 2010-2019

```{r echo=F, warning=F, message=F}
# Total Number of Offenses by Crime
ggplot(data=offenses_df,
       aes(x=data_year, y=count))+
  geom_line()+
  geom_point()+
  theme(legend.position="right")+
  scale_x_continuous(name="Year", breaks=c(2010,2015), labels=c(2010,2015))+
  scale_y_continuous(name="Number of Offenses")+
  facet_wrap(vars(offense), ncol=5, scales="free")
```

**Fig 7:** Total Number of Offenses by Crime 

```{r echo=F, warning=F, message=F}
# what do I want?
# 1 figure (per demographic feature)
# 10 graphs (for each crime)
# each is line graph with 10 years as axis
# each graph has x lines for x features

temp <- offenses_df %>% 
  gather(key="age", value="num_offenders", "0-9":"90-older")

ggplot(data=temp,
       aes(x=data_year, y=num_offenders, group=age))+
  geom_line(aes(color=age))+
  geom_point(aes(color=age))+
  theme(legend.position="right")+
  scale_x_continuous(name="Year", breaks=c(2010,2015), labels=c(2010,2015))+
  scale_y_continuous(name="Number of Offenses")+
  facet_wrap(vars(offense), ncol=5, scales="free")

rm(temp)
```

**Fig 8:** Offenses by crime and age group

```{r echo=F, warning=F, message=F}
temp <- offenses_df %>% 
  gather(key="race", value="num_offenders", "american indian or alaska native":"black or african american", "white")

ggplot(data=temp,
       aes(x=data_year, y=num_offenders, group=race))+
  geom_line(aes(color=race))+
  geom_point(aes(color=race))+
  theme(legend.position="right")+
  scale_x_continuous(name="Year", breaks=c(2010,2015), labels=c(2010,2015))+
  scale_y_continuous(name="Number of Offenses")+
  facet_wrap(vars(offense), ncol=5, scales="free")

rm(temp)
```

**Fig 9:** Offenses by crime and race

```{r echo=F, warning=F, message=F}
temp <- offenses_df %>% 
  gather(key="sex", value="num_offenders", "female":"male")

ggplot(data=temp,
       aes(x=data_year, y=num_offenders, group=sex))+
  geom_line(aes(color=sex))+
  geom_point(aes(color=sex))+
  theme(legend.position="right")+
  scale_x_continuous(name="Year", breaks=c(2010,2015), labels=c(2010,2015))+
  scale_y_continuous(name="Number of Offenses")+
  facet_wrap(vars(offense), ncol=5, scales="free")

rm(temp)
```

**Fig 10:** Offenses by crime and sex

```{r echo=F, warning=F, message=F}

```


## 3. Effect of Crime Rates on Following Year's Police Employment

```{r echo=F, warning=F, message=F}
# Creating Linear Models

full_df <- merge(sc_wide,
                 (mutate(pe_recent, last_year = data_year-1)),
                 by.x=c("data_year", "state"),
                 by.y=c("last_year", "state")) %>% 
  mutate_if(is.numeric, funs(ifelse(is.na(.), 0, .)))


# Crime based model
summary(lm(officer_rate_per_1000~
             Other + Arson + Aggravated_Assault + Financial_Crime + Burglary +
             Property_Crime + `Narcotics/Alcohol` + Homicide + Trafficking +
             Larceny + Motor_Vehicle_Theft + Sex_Crime + Robbery
             ,
           data=full_df))

summary(lm(civilian_rate_per_1000~
             Other + Arson + Aggravated_Assault + Financial_Crime + Burglary +
             Property_Crime + `Narcotics/Alcohol` + Homicide + Trafficking +
             Larceny + Motor_Vehicle_Theft + Sex_Crime + Robbery
             ,
           data=full_df))

summary(lm(total_rate_per_1000~
             Other + Arson + Aggravated_Assault + Financial_Crime + Burglary +
             Property_Crime + `Narcotics/Alcohol` + Homicide + Trafficking +
             Larceny + Motor_Vehicle_Theft + Sex_Crime + Robbery
             ,
           data=full_df))


```

```{r echo=F, warning=F, message=F}
# Gender based model

  # male crime is significant predictor, female is not
summary(lm(officer_rate_per_1000~male+female,
           data=full_df))
summary(lm(civilian_rate_per_1000~male+female,
           data=full_df))
summary(lm(total_rate_per_1000~male+female,
           data=full_df))
```

```{r echo=F, warning=F, message=F}
# Race based model
  # black and white crime are significant; oddly black crime is positively correlated while white crime is negatively correlated
summary(lm(officer_rate_per_1000~native_american+asian+black+white,
           data=full_df))
  # white crime is insignificant to civilian rate
summary(lm(civilian_rate_per_1000~native_american+asian+black+white,
           data=full_df))

summary(lm(total_rate_per_1000~native_american+asian+black+white,
           data=full_df))
```

```{r echo=F, warning=F, message=F}
# Age based model
summary(lm(officer_rate_per_1000~`0_9`+`10_19`+`20_29`+`30_39`+`40_49`+`50_59`+`60_69`+`70_79`+`80_89`+`90_older`,
           data=full_df))
summary(lm(civilian_rate_per_1000~`0_9`+`10_19`+`20_29`+`30_39`+`40_49`+`50_59`+`60_69`+`70_79`+`80_89`+`90_older`,
           data=full_df))
summary(lm(total_rate_per_1000~`0_9`+`10_19`+`20_29`+`30_39`+`40_49`+`50_59`+`60_69`+`70_79`+`80_89`+`90_older`,
           data=full_df))
```


## 4. Effect of Police Employment on Crime Rates

```{r echo=F, warning=F, message=F}
# Create linear models

pe_crime_df <- merge(sc_long,
                      pe_recent,
                      by=c("data_year", "state")) %>% 
  mutate_if(is.numeric, funs(ifelse(is.na(.), 0, .))) %>% 
  group_by(data_year, state) %>% 
  summarise(offense_rate = sum(total_offenses),
            officer_rate = mean(officer_rate_per_1000),
            civilian_rate = mean(civilian_rate_per_1000),
            total_rate = mean(total_rate_per_1000)
            ) %>% 
  ungroup()
  
pe_crime_df <- pe_crime_df %>% 
  group_by(state) %>% 
  slice(which.min(offense_rate)) %>% 
  mutate(is_min = "min") %>% 
  merge(pe_crime_df, all=T) %>% 
  mutate_all(funs(ifelse(is.na(.), "not_min", .)))

pe_crime_df <- pe_crime_df %>% 
  group_by(state) %>% 
  slice(which.max(offense_rate)) %>% 
  mutate(is_max = "max") %>% 
  merge(pe_crime_df, all=T) %>% 
  mutate_all(funs(ifelse(is.na(.), "not_max", .)))
```


```{r echo=F, warning=F, message=F}
summary(lm(offense_rate~officer_rate,
           data=pe_crime_df))

ggplot(data=pe_crime_df,
       mapping=aes(x=officer_rate, y=offense_rate))+
  geom_point(aes(color=is_min))+
  geom_smooth(se=F,
              method="lm",
              formula=y~x)+
  theme_minimal()+
  scale_color_manual(values=c("red", "black"))
```

```{r echo=F, warning=F, message=F}
summary(lm(offense_rate~civilian_rate,
           data=pe_crime_df))

ggplot(data=pe_crime_df,
       mapping=aes(x=civilian_rate, y=offense_rate))+
  geom_point(aes(color=is_min))+
  geom_smooth(se=F,
              method="lm",
              formula=y~x)+
  theme_minimal()+
  scale_color_manual(values=c("red", "black"))
```

```{r echo=F, warning=F, message=F}
summary(lm(offense_rate~total_rate,
           data=pe_crime_df))

ggplot(data=pe_crime_df,
       mapping=aes(x=total_rate, y=offense_rate))+
  geom_point(aes(color=is_min))+
  geom_smooth(se=F,
              method="lm",
              formula=y~x)+
  theme_minimal()+
  scale_color_manual(values=c("red", "black"))
```


Compare 5 highest and 5 lowest officer rate states over time.

In these states, look at which types of crimes were committed the most.






















